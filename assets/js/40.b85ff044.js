(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{493:function(s,t,a){"use strict";a.r(t);var e=a(29),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("[toc]")]),s._v(" "),a("h1",{attrs:{id:"搭建私服"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建私服"}},[s._v("#")]),s._v(" 搭建私服")]),s._v(" "),a("h2",{attrs:{id:"docker-registry"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-registry"}},[s._v("#")]),s._v(" docker-registry")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("下载registry")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull registry\n")])])])]),s._v(" "),a("li",[a("p",[s._v("启动容器")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000 -v /tmp/myregistry/:/tmp/registry --privileged"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true registry\n")])])])]),s._v(" "),a("li",[a("p",[s._v("修改 "),a("code",[s._v("/etc/docker/daemon.json")])]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"insecure-registries"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0:5000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("重启服务")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl daemon-reload\nsystemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("执行命令")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" tag myubuntu:1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:5000/myubuntu:1.1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" push "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:5000/myubuntu:1.1\n")])])])]),s._v(" "),a("li",[a("p",[s._v("查看私服库的镜像")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -XGET http://0.0.0.0:5000/v2/_catalog\n")])])])])]),s._v(" "),a("h2",{attrs:{id:"harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor"}},[s._v("#")]),s._v(" Harbor")]),s._v(" "),a("p",[s._v("Harbor相比较于registry，提供了web管理界面，更详细的账户、权限管理，还可以配置漏洞扫描等工具")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("安装docker compose")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/docker/compose/releases/download/v2.4.1/docker-compose-linux-x86_64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" docker-compose-linux-x86_64 /usr/local/lib/docker/cli-plugins/docker-compose\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /usr/local/lib/docker/cli-plugins/docker-compose\n")])])]),a("p",[s._v("测试安装")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" compose version\n")])])])]),s._v(" "),a("li",[a("p",[s._v("下载Harbor")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/goharbor/harbor/releases/download/v2.5.0/harbor-offline-installer-v2.5.0.tgz\n")])])])]),s._v(" "),a("li",[a("p",[s._v("解压harbor")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf harbor-offline-installer-v2.5.0.tgz -C /usr/local/\n")])])])]),s._v(" "),a("li",[a("p",[s._v("配置harbor")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" harbor.yml.tmpl harbor.yml\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v(" harbor.yml\n")])])]),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Configuration file of Harbor")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The IP address or hostname to access admin UI and registry service.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#改为域名或本机ip")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http related config")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# port for http, default is 80. If https enabled, this port will redirect to https port")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将https相关证书注释掉")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https related config")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#https:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https port for harbor, default is 443")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#port: 443")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The path of cert and key files for nginx")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#certificate: /your/certificate/path")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#private_key: /your/private/key/path")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # Uncomment following will enable tls communication between all harbor components")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# internal_tls:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   # set enabled to true means internal tls is enabled")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   enabled: true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   # put your cert and key files on dir")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   dir: /etc/harbor/tls/internal")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("运行安装脚本")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" ./install.sh --with-trivy --with-chartmuseum\n")])])])]),s._v(" "),a("li",[a("p",[s._v("让docker信任harbo")]),s._v(" "),a("p",[s._v("修改 "),a("code",[s._v("/etc/docker/daemon.json")])]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"insecure-registries"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("docker使用harbo仓库")]),s._v(" "),a("p",[s._v("访问harbo的地址，默认账户：admin,密码：Harbo12345")]),s._v(" "),a("ol",[a("li",[s._v("新建项目")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://ciallo-1257179806.cos.ap-shanghai.myqcloud.com/image-20220415175640371.png",alt:"image-20220415175640371"}}),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[s._v("修改镜像标签符合仓库规范")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" tag myubuntu:1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/test/myubuntu:1.1\n")])])])]),s._v(" "),a("li",[a("p",[s._v("docker login")]),s._v(" "),a("p",[s._v("使用harbo的账户进行登录")])]),s._v(" "),a("li",[a("p",[s._v("上传镜像")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("root@kiro:/etc/docker"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker push 0.0.0.0/test/myubuntu:1.1")]),s._v("\nThe push refers to repository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/test/myubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n6f655c8e517c: Layer already exists\n0828ee65565c: Layer already exists\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(": digest: sha256:74d9c297f70fccb8c041d7f22cea6acc58d97bd53b54a61e95df68c62a13330e size: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("741")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("拉取镜像")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0/test/myubuntu:1.1\n")])])])])])])])])}),[],!1,null,null,null);t.default=r.exports}}]);