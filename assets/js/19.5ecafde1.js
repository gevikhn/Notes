(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{475:function(n,t,a){"use strict";a.r(t);var e=a(29),s=Object(e.a)({},(function(){var n=this,t=n.$createElement,a=n._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"服务消费-ribbon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务消费-ribbon"}},[n._v("#")]),n._v(" 服务消费(Ribbon)")]),n._v(" "),a("blockquote",[a("p",[n._v("在"),a("RouterLink",{attrs:{to:"/03.SpringCloud/服务消费.html"}},[n._v("服务消费")]),n._v("中，通过"),a("code",[n._v("LoadBalancerClient")]),n._v("接口来获取某个服务的实例，并根据实例信息来发起服务接口消费请求，通过手动的去编写服务选取、链接拼接，这些有点太过繁琐，")],1)]),n._v(" "),a("h2",{attrs:{id:"ribbon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ribbon"}},[n._v("#")]),n._v(" Ribbon")]),n._v(" "),a("p",[n._v("SpringCloud Ribbon是Netflix Ribbon实现的一套客户端负载均衡工具。它是基于HTTP和TCP的客户端负载均衡器，可以通过在客户端中配置ribbonServerList来设置服务端列表去轮询访问以达到均衡负载的作用。")]),n._v(" "),a("blockquote",[a("p",[n._v("当Ribbon与Eureka联合使用时，ribbonServerList会被DiscoveryEnabledNIWSServerList重写，扩展成从Eureka注册中心中获取服务实例列表。同时它也会用NIWSDiscoveryPing来取代IPing，它将职责委托给Eureka来确定服务端是否已经启动。")]),n._v(" "),a("p",[n._v("而当Ribbon与Consul联合使用时，ribbonServerList会被ConsulServerList来扩展成从Consul获取服务实例列表。同时由ConsulPing来作为IPing接口的实现。")])]),n._v(" "),a("p",[n._v("在使用Spring Cloud Ribbon的时候，不论是与Eureka还是Consul结合，都会在引入Spring Cloud Eureka或Spring Cloud Consul依赖的时候通过自动化配置来加载上述所说的配置内容，所以我们可以快速在Spring Cloud中实现服务间调用的负载均衡")]),n._v(" "),a("hr"),n._v(" "),a("h2",{attrs:{id:"开始配置ribbon"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始配置ribbon"}},[n._v("#")]),n._v(" 开始配置Ribbon")]),n._v(" "),a("p",[n._v("复制eureka-consumer项目，命名为eureka-consumer-ribbon，在"),a("code",[n._v("pom.xml")]),n._v("文件中引入依赖")]),n._v(" "),a("div",{staticClass:"language-pom.xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\x3c!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-netflix-ribbon --\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>\n    <version>2.2.9.RELEASE</version>\n</dependency>\n")])])]),a("p",[a("font",{attrs:{color:"red"}},[n._v("注意！")]),n._v("这里将会出现问题\n修改主类，为"),a("code",[n._v("RestTemplate")]),n._v("添加"),a("code",[n._v("@LoadBalanced")]),n._v("注解")],1),n._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDiscoveryClient")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@SpringBootApplication")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("EurekaConsumerribbonApplication")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Bean")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@LoadBalanced")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RestTemplate")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("restTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("new")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RestTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("static")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("void")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("SpringApplication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("EurekaConsumerribbonApplication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])])]),a("p",[n._v("修改Controller，移除"),a("code",[n._v("LoadBalancerClient")]),n._v("相关代码")]),n._v(" "),a("div",{staticClass:"language-Java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@RestController")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DCController")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Autowired")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RestTemplate")]),n._v(" restTemplate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"/consumer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("dc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("return")]),n._v(" restTemplate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[n._v("getForObject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"http://eureka-client/dc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])])]),a("h2",{attrs:{id:"启动服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动服务"}},[n._v("#")]),n._v(" 启动服务")]),n._v(" "),a("p",[n._v("依次开启eureka-server,eureka-client,eureka-consumer-ribbon,访问"),a("a",{attrs:{href:"http://localhost:9001/consumer",target:"_blank",rel:"noopener noreferrer"}},[n._v("http://localhost:9001/consumer"),a("OutboundLink")],1),n._v(" "),a("font",{attrs:{color:"red"}},[n._v("发现错误！")])],1),n._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("java.lang.IllegalStateException: No instances available for eureka-client\n\tat org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerClient.execute(RibbonLoadBalancerClient.java:119) ~[spring-cloud-netflix-ribbon-2.2.9.RELEASE.jar:2.2.9.RELEASE]\n\tat org.springframework.cloud.netflix.ribbon.RibbonLoadBalancerClient.execute(RibbonLoadBalancerClient.java:99) ~[spring-cloud-netflix-ribbon-2.2.9.RELEASE.jar:2.2.9.RELEASE]\n\tat org.springframework.cloud.client.loadbalancer.LoadBalancerInterceptor.intercept(LoadBalancerInterceptor.java:56) ~[spring-cloud-commons-3.0.3.jar:3.0.3]\n\tat org.springframework.http.client.InterceptingClientHttpRequest$InterceptingRequestExecution.execute(InterceptingClientHttpRequest.java:93) ~[spring-web-5.3.9.jar:5.3.9]\n\tat org.springframework.http.client.InterceptingClientHttpRequest.executeInternal(InterceptingClientHttpRequest.java:77) ~[spring-web-5.3.9.jar:5.3.9]\n........\n")])])]),a("p",[n._v("原因是导入的"),a("code",[n._v("spring-cloud-starter-netflix-eureka-client")]),n._v("包中已经包含Ribbon,移除Ribbon依赖即可。\n最终的"),a("code",[n._v("pom.xml")]),n._v("文件")]),n._v(" "),a("div",{staticClass:"language-pom/xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.5.4</version>\n        <relativePath/> \x3c!-- lookup parent from repository --\x3e\n    </parent>\n    <groupId>com.example</groupId>\n    <artifactId>eureka-consumer-ribbon</artifactId>\n    <version>0.0.1-SNAPSHOT</version>\n    <name>eureka-consumer-ribbon</name>\n    <description>eureka-consumer-ribbon</description>\n    <properties>\n        <java.version>1.8</java.version>\n        <spring-cloud.version>2020.0.3</spring-cloud.version>\n    </properties>\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>\n        </dependency>\n\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-dependencies</artifactId>\n                <version>${spring-cloud.version}</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n\n    <build>\n        <plugins>\n            <plugin>\n                <groupId>org.springframework.boot</groupId>\n                <artifactId>spring-boot-maven-plugin</artifactId>\n            </plugin>\n        </plugins>\n    </build>\n\n</project>\n\n')])])])])}),[],!1,null,null,null);t.default=s.exports}}]);