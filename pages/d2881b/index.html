<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息驱动的微服务 | notes</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="Java,Spring,SpringBoot,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/notes/assets/css/0.styles.b4ef3752.css" as="style"><link rel="preload" href="/notes/assets/js/app.6825a617.js" as="script"><link rel="preload" href="/notes/assets/js/2.e46b09ff.js" as="script"><link rel="preload" href="/notes/assets/js/24.d7ba0b27.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.12484bc8.js"><link rel="prefetch" href="/notes/assets/js/11.6cd9c001.js"><link rel="prefetch" href="/notes/assets/js/12.ee16b483.js"><link rel="prefetch" href="/notes/assets/js/13.580082a0.js"><link rel="prefetch" href="/notes/assets/js/14.cfd02731.js"><link rel="prefetch" href="/notes/assets/js/15.28195839.js"><link rel="prefetch" href="/notes/assets/js/16.4bde6841.js"><link rel="prefetch" href="/notes/assets/js/17.2e99d9cd.js"><link rel="prefetch" href="/notes/assets/js/18.768095ed.js"><link rel="prefetch" href="/notes/assets/js/19.5ecafde1.js"><link rel="prefetch" href="/notes/assets/js/20.e3557e3d.js"><link rel="prefetch" href="/notes/assets/js/21.0faf4690.js"><link rel="prefetch" href="/notes/assets/js/22.827f6bf4.js"><link rel="prefetch" href="/notes/assets/js/23.89121fe9.js"><link rel="prefetch" href="/notes/assets/js/25.62e68202.js"><link rel="prefetch" href="/notes/assets/js/26.10f1803e.js"><link rel="prefetch" href="/notes/assets/js/27.ddfa9dec.js"><link rel="prefetch" href="/notes/assets/js/28.e848b7b0.js"><link rel="prefetch" href="/notes/assets/js/29.b3cb8a1f.js"><link rel="prefetch" href="/notes/assets/js/3.a69b7938.js"><link rel="prefetch" href="/notes/assets/js/30.3223f0e5.js"><link rel="prefetch" href="/notes/assets/js/31.762d1e17.js"><link rel="prefetch" href="/notes/assets/js/32.96165e76.js"><link rel="prefetch" href="/notes/assets/js/33.1d7efa1c.js"><link rel="prefetch" href="/notes/assets/js/34.929684a9.js"><link rel="prefetch" href="/notes/assets/js/35.e542a83f.js"><link rel="prefetch" href="/notes/assets/js/36.89b4fa4a.js"><link rel="prefetch" href="/notes/assets/js/37.c524ca44.js"><link rel="prefetch" href="/notes/assets/js/38.9459c8b3.js"><link rel="prefetch" href="/notes/assets/js/39.da7c15b5.js"><link rel="prefetch" href="/notes/assets/js/4.fb91bec8.js"><link rel="prefetch" href="/notes/assets/js/40.b85ff044.js"><link rel="prefetch" href="/notes/assets/js/41.b398f317.js"><link rel="prefetch" href="/notes/assets/js/42.7bca8f03.js"><link rel="prefetch" href="/notes/assets/js/43.ce9bed7c.js"><link rel="prefetch" href="/notes/assets/js/44.b5bb568e.js"><link rel="prefetch" href="/notes/assets/js/45.d6b9024f.js"><link rel="prefetch" href="/notes/assets/js/46.d672c877.js"><link rel="prefetch" href="/notes/assets/js/47.75443c1b.js"><link rel="prefetch" href="/notes/assets/js/48.69483f56.js"><link rel="prefetch" href="/notes/assets/js/49.939812ea.js"><link rel="prefetch" href="/notes/assets/js/5.702d3e9f.js"><link rel="prefetch" href="/notes/assets/js/50.55911bbf.js"><link rel="prefetch" href="/notes/assets/js/51.745735bf.js"><link rel="prefetch" href="/notes/assets/js/52.14c95bcd.js"><link rel="prefetch" href="/notes/assets/js/53.5361b8fb.js"><link rel="prefetch" href="/notes/assets/js/54.a6b56739.js"><link rel="prefetch" href="/notes/assets/js/55.fb47d51e.js"><link rel="prefetch" href="/notes/assets/js/56.e9c43b37.js"><link rel="prefetch" href="/notes/assets/js/57.4bb06b31.js"><link rel="prefetch" href="/notes/assets/js/58.4c0b7ef2.js"><link rel="prefetch" href="/notes/assets/js/59.00706c4c.js"><link rel="prefetch" href="/notes/assets/js/6.39aad29b.js"><link rel="prefetch" href="/notes/assets/js/7.ba69fa2e.js"><link rel="prefetch" href="/notes/assets/js/8.38b77b60.js"><link rel="prefetch" href="/notes/assets/js/9.5ed8a1c5.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.b4ef3752.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><img src="/notes/img/logo.png" alt="notes" class="logo"> <span class="site-name can-hide">notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/Java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/notes/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><a href="/notes/SpringCloud/" class="link-title">SpringCloud</a> <span class="title" style="display:none;">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/pages/6d3e7e/" class="nav-link">服务治理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/notes/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/notes/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/notes/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/Java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/notes/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><a href="/notes/SpringCloud/" class="link-title">SpringCloud</a> <span class="title" style="display:none;">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/pages/6d3e7e/" class="nav-link">服务治理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/notes/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/notes/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/notes/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/notes/pages/6d3e7e/" class="sidebar-link">服务治理</a></li><li><a href="/notes/pages/cc1465/" class="sidebar-link">服务消费</a></li><li><a href="/notes/pages/e51ccb/" class="sidebar-link">服务消费Ribbon</a></li><li><a href="/notes/pages/e27e3e/" class="sidebar-link">服务消费Feign</a></li><li><a href="/notes/pages/e3f7fb/" class="sidebar-link">配置中心</a></li><li><a href="/notes/pages/e610d6/" class="sidebar-link">服务网关</a></li><li><a href="/notes/pages/de500c/" class="sidebar-link">服务容错保护</a></li><li><a href="/notes/pages/d2881b/" aria-current="page" class="active sidebar-link">消息驱动的微服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/notes/pages/d2881b/#构建生产者" class="sidebar-link">构建生产者</a></li><li class="sidebar-sub-header level2"><a href="/notes/pages/d2881b/#构建消费者" class="sidebar-link">构建消费者</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Alibaba</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/notes/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/notes/SpringCloud/#SpringCloud" data-v-1baff76c>SpringCloud</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/gevikhn" target="_blank" title="作者" class="beLink" data-v-1baff76c>nanami</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2021-12-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">消息驱动的微服务<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="消息驱动的微服务-rabbitmq"><a href="#消息驱动的微服务-rabbitmq" class="header-anchor">#</a> 消息驱动的微服务：RabbitMQ</h1> <blockquote><p>Spring Cloud Stream 是一个用于构建基于消息的微服务应用框架，使用 Spring Integration 与 Broker 进行连接。
Spring Cloud Stream 提供了消息中间件的统一抽象，推出了 publish-subscribe、consumer groups、partition 这些统一的概念。
Spring Cloud Stream 内部有两个概念：Binder 和 Binding。</p></blockquote> <ul><li><p>Binder，跟消息中间件集成的组件，用来创建对应的 Binding。各消息中间件都有自己的 Binder 具体实现。</p></li> <li><p>Binding，包括 Input Binding 和 Output Binding。Binding 在消息中间件与应用程序提供的 Provider 和 Consumer 之间提供了一个桥梁，实现了开发者只需使用应用程序的 Provider 或 Consumer 生产或消费数据即可，屏蔽了开发者与底层消息中间件的接触。</p></li></ul> <h2 id="构建生产者"><a href="#构建生产者" class="header-anchor">#</a> 构建生产者</h2> <ul><li>在pom.xml中引入依赖</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>stream<span class="token operator">-</span>rabbit<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div><ul><li>application.yml配置文件</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>producer<span class="token punctuation">-</span>application
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment"># Spring Cloud Stream 配置项，对应 BindingServiceProperties 类</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token comment"># Binder 配置项，对应 BinderProperties Map</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span>
        <span class="token key atrule">rabbit001</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 设置 Binder 的类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置 Binder 的环境配置</span>
            <span class="token comment"># 如果是 RabbitMQ 类型的时候，则对应的是 RabbitProperties 类</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 <span class="token comment"># RabbitMQ 服务的地址</span>
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># RabbitMQ 服务的端口</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest <span class="token comment"># RabbitMQ 服务的账号</span>
                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest <span class="token comment"># RabbitMQ 服务的密码</span>
      <span class="token comment"># Binding 配置项，对应 BindingProperties Map</span>
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span>
        <span class="token key atrule">output</span><span class="token punctuation">:</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> input <span class="token comment"># 目的地。这里使用 RabbitMQ Exchange</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 内容格式。这里使用 JSON</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> rabbit001 <span class="token comment"># 设置使用的 Binder 名字</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18080</span>
</code></pre></div><ol><li><code>spring.cloud.stream</code>为 Spring Cloud Stream 配置项，对应 BindingServiceProperties 类</li> <li><code>spring.cloud.stream.binders</code>为 Binder 配置项，对应 BinderProperties Map。其中 key 为 Binder 的名字
在此创建了一个名为rabbit001的binder
<ul><li><code>type</code>: Binder 的类型。设置为 rabbit，表示使用 Spring Cloud Stream RabbitMQ 提供的 Binder 实现</li> <li><code>environment</code>:Binder 的环境。因为 Spring Cloud Steam RabbitMQ 底层使用的是 spring-rabbit，所以在使用 RabbitMQ 类型的时候，则对应的是 RabbitProperties 类</li></ul></li> <li><code>spring.cloud.stream.bindings</code>为 Binding 配置项，对应 BindingProperties Map。其中，key 为 Binding 的名字。要注意，虽然说 Binding 分成 Input 和 Output 两种类型，但是在配置项中并不会体现出来，而是要在稍后搭配 @Input 还是 @Output 注解，才会有具体的区分。
在此配置一个名为<code>demo01-output</code>的binding
<ul><li><code>destination</code>：目的地。在 RabbitMQ 中，使用 <code>Exchange</code> 作为目的地，默认为 <code>Topic</code> 类型</li> <li><code>content-type</code>：内容格式。这里使用 JSON 格式，因为稍后我们将发送消息的类型为 POJO，使用 JSON 进行序列化</li> <li><code>binder</code>：使用的 Binder 名字。这里我们设置为 <code>rabbit001</code></li></ul></li></ol> <ul><li><p>创建MySource接口</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MySource</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Output</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">)</span>
  <span class="token class-name">MessageChannel</span> <span class="token function">demo01Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>创建Controller</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/demo01&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MySource</span> mySource<span class="token punctuation">;</span> <span class="token comment">// &lt;X&gt;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/send&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &lt;1&gt; 创建 Message</span>
        <span class="token comment">// &lt;2&gt; 创建 Spring Message 对象</span>
        <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> springMessage <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token string">&quot;ciallo&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &lt;3&gt; 发送消息</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> mySource<span class="token punctuation">.</span><span class="token function">demo01Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>springMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[send][发送成功]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>在主类上添加<code>@EnableBinding(MySource.class)</code>注解</p></li></ul> <h2 id="构建消费者"><a href="#构建消费者" class="header-anchor">#</a> 构建消费者</h2> <ul><li><p>引入依赖，与生产者依赖相同</p></li> <li><p>配置文件</p> <div class="language-Java extra-class"><pre class="language-java"><code>spring<span class="token operator">:</span>
application<span class="token operator">:</span>
    name<span class="token operator">:</span> demo<span class="token operator">-</span>consumer<span class="token operator">-</span>application
cloud<span class="token operator">:</span>
    # <span class="token class-name">Spring</span> <span class="token class-name">Cloud</span> <span class="token class-name">Stream</span> 配置项，对应 <span class="token class-name">BindingServiceProperties</span> 类
    stream<span class="token operator">:</span>
    # <span class="token class-name">Binder</span> 配置项，对应 <span class="token class-name">BinderProperties</span> <span class="token class-name">Map</span>
    binders<span class="token operator">:</span>
        rabbit001<span class="token operator">:</span>
        type<span class="token operator">:</span> rabbit # 设置 <span class="token class-name">Binder</span> 的类型
        environment<span class="token operator">:</span> # 设置 <span class="token class-name">Binder</span> 的环境配置
            # 如果是 <span class="token class-name">RabbitMQ</span> 类型的时候，则对应的是 <span class="token class-name">RabbitProperties</span> 类
            spring<span class="token operator">:</span>
            rabbitmq<span class="token operator">:</span>
                host<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> # <span class="token class-name">RabbitMQ</span> 服务的地址
                port<span class="token operator">:</span> <span class="token number">5672</span> # <span class="token class-name">RabbitMQ</span> 服务的端口
                username<span class="token operator">:</span> guest # <span class="token class-name">RabbitMQ</span> 服务的账号
                password<span class="token operator">:</span> guest # <span class="token class-name">RabbitMQ</span> 服务的密码
    # <span class="token class-name">Binding</span> 配置项，对应 <span class="token class-name">BindingProperties</span> <span class="token class-name">Map</span>
    bindings<span class="token operator">:</span>
        input<span class="token operator">:</span>
        destination<span class="token operator">:</span> input # 目的地。这里使用 <span class="token class-name">RabbitMQ</span> <span class="token class-name">Exchange</span>
        content<span class="token operator">-</span>type<span class="token operator">:</span> application<span class="token operator">/</span>json # 内容格式。这里使用 JSON
        group<span class="token operator">:</span> demo01<span class="token operator">-</span>consumer<span class="token operator">-</span>group<span class="token operator">-</span>DEMO<span class="token operator">-</span>TOPIC<span class="token operator">-</span><span class="token number">01</span> # 消费者分组
        binder<span class="token operator">:</span> rabbit001  # 设置使用的 <span class="token class-name">Binder</span> 名字

server<span class="token operator">:</span>
port<span class="token operator">:</span> $<span class="token punctuation">{</span>random<span class="token punctuation">.</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token number">19999</span><span class="token punctuation">]</span><span class="token punctuation">}</span> # 随机端口，方便启动多个消费者

</code></pre></div><ul><li><p><code>group</code>:消费者分组</p> <blockquote><p>消费者组（Consumer Group）：同一类 Consumer 的集合，这类 Consumer 通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的 Topic。</p></blockquote></li></ul></li></ul> <p>对于消费队列的消费者，会有两种消费模式：集群消费（Clustering）和广播消费（Broadcasting）。</p> <blockquote><ul><li>集群消费（Clustering）：集群消费模式下,相同 Consumer Group 的每个 Consumer 实例平均分摊消息。</li> <li>广播消费（Broadcasting）：广播消费模式下，相同 Consumer Group 的每个 Consumer 实例都接收全量的消息</li></ul></blockquote> <ul><li><p>创建消费者类</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkReceiver</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SinkReceiver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">Object</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span> <span class="token operator">+</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>已经能够在多实例环境下，保证同一消息只被同一个组内的一个消费者实例进行接收和处理</strong>
对于一些特殊场景，除了要保证单一实例消费之外，还希望那些具备相同特征的消息都能够被同一个实例进行消费</p> <ul><li><p>消息分区
在消费者工程的配置文件中添加以下配置</p> <div class="language-Java extra-class"><pre class="language-java"><code>spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span>input<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>partitioned<span class="token operator">=</span><span class="token boolean">true</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>instanceCount<span class="token operator">=</span><span class="token number">2</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>instanceIndex<span class="token operator">=</span><span class="token number">0</span>
</code></pre></div><p><code>spring.cloud.stream.bindings.input.consumer.partitioned</code>：通过该参数开启消费者分区功能；</p> <p><code>spring.cloud.stream.instanceCount</code>：该参数指定了当前消费者的总实例数量；</p> <p><code>spring.cloud.stream.instanceIndex</code>：该参数设置当前实例的索引号，从0开始，最大值为<code>spring.cloud.stream.instanceCount</code>参数 - 1。我们试验的时候需要启动多个实例，可以通过运行参数来为不同实例设置不同的索引值(<code>spring.cloud.stream.instanceIndex = ${INDEX:0}</code>)</p> <p>在生产者的配置文件中也做出稍许更改</p> <div class="language-Java extra-class"><pre class="language-java"><code>spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span>output<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>partitionKeyExpression<span class="token operator">=</span>payload
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span>output<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>partitionCount<span class="token operator">=</span><span class="token number">2</span>
</code></pre></div><p><code>spring.cloud.stream.bindings.output.producer.partitionKeyExpression</code>：通过该参数指定了分区键的表达式规则，我们可以根据实际的输出消息规则来配置SpEL来生成合适的分区键(设置为<code>payload</code>会根据具体消息动态选择分组，也可以直接指定分区)；</p> <p><code>spring.cloud.stream.bindings.output.producer.partitionCount</code>：该参数指定了消息分区的数量。</p></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/12/23, 23:20:56</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/notes/pages/de500c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">服务容错保护</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/notes/pages/de500c/" class="prev">服务容错保护</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/notes/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/notes/pages/892142/"><div>
            controller
            <!----></div></a> <span class="date">04-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/notes/pages/bb4118/"><div>
            pod
            <!----></div></a> <span class="date">04-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/notes/pages/48d106/"><div>
            Service
            <!----></div></a> <span class="date">04-25</span></dt></dl> <dl><dd></dd> <dt><a href="/notes/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/notes/assets/js/app.6825a617.js" defer></script><script src="/notes/assets/js/2.e46b09ff.js" defer></script><script src="/notes/assets/js/24.d7ba0b27.js" defer></script>
  </body>
</html>
