<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pod | notes</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="Java,Spring,SpringBoot,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/notes/assets/css/0.styles.b4ef3752.css" as="style"><link rel="preload" href="/notes/assets/js/app.6825a617.js" as="script"><link rel="preload" href="/notes/assets/js/2.e46b09ff.js" as="script"><link rel="preload" href="/notes/assets/js/47.75443c1b.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.12484bc8.js"><link rel="prefetch" href="/notes/assets/js/11.6cd9c001.js"><link rel="prefetch" href="/notes/assets/js/12.ee16b483.js"><link rel="prefetch" href="/notes/assets/js/13.580082a0.js"><link rel="prefetch" href="/notes/assets/js/14.cfd02731.js"><link rel="prefetch" href="/notes/assets/js/15.28195839.js"><link rel="prefetch" href="/notes/assets/js/16.4bde6841.js"><link rel="prefetch" href="/notes/assets/js/17.2e99d9cd.js"><link rel="prefetch" href="/notes/assets/js/18.768095ed.js"><link rel="prefetch" href="/notes/assets/js/19.5ecafde1.js"><link rel="prefetch" href="/notes/assets/js/20.e3557e3d.js"><link rel="prefetch" href="/notes/assets/js/21.0faf4690.js"><link rel="prefetch" href="/notes/assets/js/22.827f6bf4.js"><link rel="prefetch" href="/notes/assets/js/23.89121fe9.js"><link rel="prefetch" href="/notes/assets/js/24.d7ba0b27.js"><link rel="prefetch" href="/notes/assets/js/25.62e68202.js"><link rel="prefetch" href="/notes/assets/js/26.10f1803e.js"><link rel="prefetch" href="/notes/assets/js/27.ddfa9dec.js"><link rel="prefetch" href="/notes/assets/js/28.e848b7b0.js"><link rel="prefetch" href="/notes/assets/js/29.b3cb8a1f.js"><link rel="prefetch" href="/notes/assets/js/3.a69b7938.js"><link rel="prefetch" href="/notes/assets/js/30.3223f0e5.js"><link rel="prefetch" href="/notes/assets/js/31.762d1e17.js"><link rel="prefetch" href="/notes/assets/js/32.96165e76.js"><link rel="prefetch" href="/notes/assets/js/33.1d7efa1c.js"><link rel="prefetch" href="/notes/assets/js/34.929684a9.js"><link rel="prefetch" href="/notes/assets/js/35.e542a83f.js"><link rel="prefetch" href="/notes/assets/js/36.89b4fa4a.js"><link rel="prefetch" href="/notes/assets/js/37.c524ca44.js"><link rel="prefetch" href="/notes/assets/js/38.9459c8b3.js"><link rel="prefetch" href="/notes/assets/js/39.da7c15b5.js"><link rel="prefetch" href="/notes/assets/js/4.fb91bec8.js"><link rel="prefetch" href="/notes/assets/js/40.b85ff044.js"><link rel="prefetch" href="/notes/assets/js/41.b398f317.js"><link rel="prefetch" href="/notes/assets/js/42.7bca8f03.js"><link rel="prefetch" href="/notes/assets/js/43.ce9bed7c.js"><link rel="prefetch" href="/notes/assets/js/44.b5bb568e.js"><link rel="prefetch" href="/notes/assets/js/45.d6b9024f.js"><link rel="prefetch" href="/notes/assets/js/46.d672c877.js"><link rel="prefetch" href="/notes/assets/js/48.69483f56.js"><link rel="prefetch" href="/notes/assets/js/49.939812ea.js"><link rel="prefetch" href="/notes/assets/js/5.702d3e9f.js"><link rel="prefetch" href="/notes/assets/js/50.55911bbf.js"><link rel="prefetch" href="/notes/assets/js/51.745735bf.js"><link rel="prefetch" href="/notes/assets/js/52.14c95bcd.js"><link rel="prefetch" href="/notes/assets/js/53.5361b8fb.js"><link rel="prefetch" href="/notes/assets/js/54.a6b56739.js"><link rel="prefetch" href="/notes/assets/js/55.fb47d51e.js"><link rel="prefetch" href="/notes/assets/js/56.e9c43b37.js"><link rel="prefetch" href="/notes/assets/js/57.4bb06b31.js"><link rel="prefetch" href="/notes/assets/js/58.4c0b7ef2.js"><link rel="prefetch" href="/notes/assets/js/59.00706c4c.js"><link rel="prefetch" href="/notes/assets/js/6.39aad29b.js"><link rel="prefetch" href="/notes/assets/js/7.ba69fa2e.js"><link rel="prefetch" href="/notes/assets/js/8.38b77b60.js"><link rel="prefetch" href="/notes/assets/js/9.5ed8a1c5.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.b4ef3752.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><img src="/notes/img/logo.png" alt="notes" class="logo"> <span class="site-name can-hide">notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/Java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/notes/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><a href="/notes/SpringCloud/" class="link-title">SpringCloud</a> <span class="title" style="display:none;">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/pages/6d3e7e/" class="nav-link">服务治理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/notes/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/notes/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/notes/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/notes/Java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/notes/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><a href="/notes/SpringCloud/" class="link-title">SpringCloud</a> <span class="title" style="display:none;">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/pages/6d3e7e/" class="nav-link">服务治理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/notes/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/notes/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/notes/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/notes/pages/8149aa/" class="sidebar-link">基本概念</a></li><li><a href="/notes/pages/566d32/" class="sidebar-link">安装部署</a></li><li><a href="/notes/pages/ec9bd7/" class="sidebar-link">资源编排</a></li><li><a href="/notes/pages/bb4118/" aria-current="page" class="active sidebar-link">pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#镜像拉取" class="sidebar-link">镜像拉取</a></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#资源限制" class="sidebar-link">资源限制</a></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#重启策略" class="sidebar-link">重启策略</a></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#容器探针" class="sidebar-link">容器探针</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#检查机制" class="sidebar-link">检查机制</a></li><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#探测结果" class="sidebar-link">探测结果</a></li><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#探测类型" class="sidebar-link">探测类型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#调度" class="sidebar-link">调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#kube-scheduler" class="sidebar-link">kube-scheduler</a></li><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#kube-scheduler-调度流程" class="sidebar-link">kube-scheduler 调度流程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#为pod指派节点" class="sidebar-link">为pod指派节点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#节点标签" class="sidebar-link">节点标签</a></li><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#亲和性与反亲和性" class="sidebar-link">亲和性与反亲和性</a></li><li class="sidebar-sub-header level3"><a href="/notes/pages/bb4118/#nodename" class="sidebar-link">nodename</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notes/pages/bb4118/#污点和容忍度" class="sidebar-link">污点和容忍度</a></li></ul></li><li><a href="/notes/pages/892142/" class="sidebar-link">controller</a></li><li><a href="/notes/pages/48d106/" class="sidebar-link">Service</a></li><li><a href="/notes/pages/5ac46f/" class="sidebar-link">Jobs&amp;CronJob</a></li><li><a href="/notes/pages/777b8e/" class="sidebar-link">其他</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/notes/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/notes/categories/?category=k8s" title="分类" data-v-1baff76c>k8s</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/gevikhn" target="_blank" title="作者" class="beLink" data-v-1baff76c>nanami</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-04-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">pod<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>[toc]</p> <h1 id="pod"><a href="#pod" class="header-anchor">#</a> pod</h1> <h2 id="镜像拉取"><a href="#镜像拉取" class="header-anchor">#</a> 镜像拉取</h2> <ul><li><p>镜像拉取策略</p> <ul><li><p>IfNotPresent</p> <p>默认值，镜像不在宿主机上时才拉取</p></li> <li><p>Always</p> <p>每次创建pod都会重新拉取镜像</p></li> <li><p>Never</p> <p>pod永远不会主动拉取镜像</p></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
</code></pre></div></li></ul> <h2 id="资源限制"><a href="#资源限制" class="header-anchor">#</a> 资源限制</h2> <blockquote><p>CPU 资源单位 : CPU 资源的约束和请求以 “cpu” 为单位。 在 Kubernetes 中，一个 CPU 等于1 个物理 CPU 核 或者 一个虚拟核， 取决于节点是一台物理主机还是运行在某物理主机上的虚拟机。</p> <p>memory 的约束和请求以字节为单位。</p></blockquote> <ul><li>request</li> <li>limit</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app
    <span class="token key atrule">image</span><span class="token punctuation">:</span> images.my<span class="token punctuation">-</span>company.example/app<span class="token punctuation">:</span>v4
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;64Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;250m&quot;</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;128Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;500m&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>aggregator
    <span class="token key atrule">image</span><span class="token punctuation">:</span> images.my<span class="token punctuation">-</span>company.example/log<span class="token punctuation">-</span>aggregator<span class="token punctuation">:</span>v6
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;64Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;250m&quot;</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;128Mi&quot;</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;500m&quot;</span>
</code></pre></div><h2 id="重启策略"><a href="#重启策略" class="header-anchor">#</a> 重启策略</h2> <ul><li><p>Always：默认策略</p> <p>容器终止退出时，总是重启容器</p></li> <li><p>OnFailure</p> <p>容器异常退出时，重启容器</p></li> <li><p>Never</p> <p>容器终止退出时，从不重启容器</p></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
</code></pre></div><h2 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h2> <ul><li>pod阶段</li></ul> <table><thead><tr><th>值</th> <th>描述</th></tr></thead> <tbody><tr><td>Pending</td> <td>Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td></tr> <tr><td>Running</td> <td>Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</td></tr> <tr><td>Succeeded</td> <td>Pod 中的所有容器都已成功终止，并且不会再重启。</td></tr> <tr><td>Failed</td> <td>Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止</td></tr> <tr><td>Unknown</td> <td>因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</td></tr></tbody></table> <ul><li><p>容器状态</p> <ul><li><p>Waiting</p> <p>容器正在完成启动所需要的操作：拉取镜像、向容器应用 <a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Secret<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 数据</p></li> <li><p>Running</p> <p>表明容器正在执行状态并且没有问题发生。 如果配置了 <code>postStart</code> 回调，那么该回调已经执行且已完成</p></li> <li><p>Terminated</p> <p>正常结束或者因为某些原因失败</p></li></ul></li></ul> <h2 id="容器探针"><a href="#容器探针" class="header-anchor">#</a> 容器探针</h2> <h3 id="检查机制"><a href="#检查机制" class="header-anchor">#</a> 检查机制</h3> <ul><li><p>exec</p> <p>在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</p></li> <li><p>grpc</p> <p>使用 <a href="https://grpc.io/" target="_blank" rel="noopener noreferrer">gRPC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 执行一个远程过程调用。 目标应该实现 <a href="https://grpc.io/grpc/core/md_doc_health-checking.html" target="_blank" rel="noopener noreferrer">gRPC健康检查<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 如果响应的状态是 &quot;SERVING&quot;，则认为诊断成功。 gRPC 探针是一个 alpha 特性，只有在启用了 &quot;GRPCContainerProbe&quot; <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/feature-gate/" target="_blank" rel="noopener noreferrer">特性门控<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>时才能使用。</p></li> <li><p>httpGet</p> <p>对容器的 IP 地址上指定端口和路径执行 HTTP <code>GET</code> 请求。如果响应的状态码大于等于 200 且小于 400，则诊断被认为是成功的。</p></li> <li><p>tcpSocket</p> <p>对容器的 IP 地址上的指定端口执行 TCP 检查。如果端口打开，则诊断被认为是成功的。 如果远程系统（容器）在打开连接后立即将其关闭，也算作是健康的</p> <h3 id="探测结果"><a href="#探测结果" class="header-anchor">#</a> 探测结果</h3></li> <li><p>Success：容器通过了诊断</p></li> <li><p>Failure：容器未通过诊断</p></li> <li><p>Unknown：诊断失败，因此不会采取任何行动</p></li></ul> <h3 id="探测类型"><a href="#探测类型" class="header-anchor">#</a> 探测类型</h3> <ul><li><p>livenessProbe</p> <p>指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener noreferrer">重启策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>决定未来。如果容器不提供存活探针， 则默认状态为 <code>Success</code>。</p></li> <li><p>readinessProbe</p> <p>指示容器是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 匹配的所有服务的端点列表中删除该 Pod 的 IP 地址。 初始延迟之前的就绪态的状态值默认为 <code>Failure</code>。 如果容器不提供就绪态探针，则默认状态为 <code>Success</code>。</p></li> <li><p>startupProbe</p> <p>指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被 禁用，直到此探针成功为止。如果启动探测失败，<code>kubelet</code> 将杀死容器，而容器依其 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener noreferrer">重启策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行重启。 如果容器没有提供启动探测，则默认状态为 <code>Success</code>。</p></li></ul> <h2 id="调度"><a href="#调度" class="header-anchor">#</a> 调度</h2> <blockquote><p>在 Kubernetes 中，调度 是指将 Pod 放置到合适的 Node 上，然后对应 Node 上的 Kubelet 才能够运行这些 pod</p></blockquote> <p>调度器通过 kubernetes 的监测（Watch）机制来发现集群中新创建且尚未被调度到 Node 上的 Pod。 调度器会将发现的每一个未调度的 Pod 调度到一个合适的 Node 上来运行。 调度器会依据下文的调度原则来做出调度选择。</p> <h3 id="kube-scheduler"><a href="#kube-scheduler" class="header-anchor">#</a> kube-scheduler</h3> <p><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-scheduler/" target="_blank" rel="noopener noreferrer">kube-scheduler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Kubernetes 集群的默认调度器，对每一个新创建的 Pod 或者是未被调度的 Pod，kube-scheduler 会选择一个最优的 Node 去运行这个 Pod。在一个集群中，满足一个 Pod 调度请求的所有 Node 称之为 <em>可调度节点</em>。 如果没有任何一个 Node 能满足 Pod 的资源请求，那么这个 Pod 将一直停留在 未调度状态直到调度器能够找到合适的 Node。</p> <p>调度器先在集群中找到一个 Pod 的所有可调度节点，然后根据一系列函数对这些可调度节点打分， 选出其中得分最高的 Node 来运行 Pod。之后，调度器将这个调度决定通知给 kube-apiserver，这个过程叫做 <em>绑定</em></p> <p>在做调度决定时需要考虑的因素包括：单独和整体的资源请求、硬件/软件/策略限制、 亲和以及反亲和要求、数据局域性、负载间的干扰等等</p> <h3 id="kube-scheduler-调度流程"><a href="#kube-scheduler-调度流程" class="header-anchor">#</a> kube-scheduler 调度流程</h3> <p>kube-scheduler 给一个 pod 做调度选择分为两步：</p> <ul><li>过滤</li> <li>打分</li></ul> <p>过滤阶段会将所有满足 Pod 调度需求的 Node 选出来。</p> <p>打分阶段，调度器会为 Pod 从所有可调度节点中选取一个最合适的 Node。 根据当前启用的打分规则，调度器会给每一个可调度节点进行打分。</p> <p>可以通过调度策略和调度配置来配置调度器的过滤和打分行为：</p> <ol><li><a href="https://kubernetes.io/zh/docs/reference/scheduling/policies" target="_blank" rel="noopener noreferrer">调度策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许配置过滤的 <em>断言(Predicates)</em> 和打分的 <em>优先级(Priorities)</em></li> <li><a href="https://kubernetes.io/zh/docs/reference/scheduling/config/#profiles" target="_blank" rel="noopener noreferrer">调度配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许配置实现不同调度阶段的插件， 包括：<code>QueueSort</code>, <code>Filter</code>, <code>Score</code>, <code>Bind</code>, <code>Reserve</code>, <code>Permit</code> 等等。 也可以配置 kube-scheduler 运行不同的配置文件。</li></ol> <h2 id="为pod指派节点"><a href="#为pod指派节点" class="header-anchor">#</a> 为pod指派节点</h2> <blockquote><p>可以约束一个 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener noreferrer">Pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 只能在特定的<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener noreferrer">节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上运行</p></blockquote> <ul><li><p><a href="#%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE">节点标签</a>和节点标签选择符</p></li> <li><p><a href="#%E4%BA%B2%E5%92%8C%E6%80%A7%E4%B8%8E%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7">亲和性和反亲和性</a></p></li> <li><p><a href="#nodename">nodename</a></p></li></ul> <h3 id="节点标签"><a href="#节点标签" class="header-anchor">#</a> 节点标签</h3> <p>通过手动给节点添加标签，以使创建的pod调度到所选择的节点上</p> <h4 id="给节点添加标签"><a href="#给节点添加标签" class="header-anchor">#</a> 给节点添加标签</h4> <ol><li><p>添加标签</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl label nodes <span class="token operator">&lt;</span>your-node-name<span class="token operator">&gt;</span> <span class="token assign-left variable">disktype</span><span class="token operator">=</span>ssd
</code></pre></div><p><img src="https://ciallo-1257179806.cos.ap-shanghai.myqcloud.com/image-20220422182152418.png" alt="image-20220422182152418"></p></li> <li><p>验证</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get nodes --show-labels
</code></pre></div><p><img src="https://ciallo-1257179806.cos.ap-shanghai.myqcloud.com/image-20220422182226846.png" alt="image-20220422182226846"></p> <p><img src="https://ciallo-1257179806.cos.ap-shanghai.myqcloud.com/image-20220422182315420.png" alt=""></p></li></ol> <h4 id="创建一个调度到特定节点上的pod"><a href="#创建一个调度到特定节点上的pod" class="header-anchor">#</a> 创建一个调度到特定节点上的pod</h4> <p>此配置文件描述了一个拥有节点选择器(nodeselector)<code>disktype=ssd</code>的Pod，该Pod将被调度到存在``disktype=ssd`的节点上</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd

</code></pre></div><ol><li><p>使用该配置文件创建一个pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f nodeselector.yaml
</code></pre></div></li> <li><p>验证 pod 是不是运行在所选择的节点上</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pods --output<span class="token operator">=</span>wide
</code></pre></div></li></ol> <hr> <h3 id="亲和性与反亲和性"><a href="#亲和性与反亲和性" class="header-anchor">#</a> 亲和性与反亲和性</h3> <blockquote><p><code>nodeSelector</code> 提供了一种最简单的方法来将 Pod 约束到具有特定标签的节点上。 亲和性和反亲和性扩展了你可以定义的约束类型</p></blockquote> <p>选择亲和性与反亲和性的理由：</p> <ul><li>亲和性、反亲和性语言的表达能力更强。<code>nodeSelector</code> 只能选择拥有所有指定标签的节点。 亲和性、反亲和性为你提供对选择逻辑的更强控制能力。</li> <li>你可以标明某规则是“软需求”或者“偏好”，这样调度器在无法找到匹配节点时仍然调度该 Pod。</li> <li>你可以使用节点上（或其他拓扑域中）运行的其他 Pod 的标签来实施调度约束， 而不是只能使用节点本身的标签。这个能力让你能够定义规则允许哪些 Pod 可以被放置在一起。</li></ul> <h4 id="节点亲和性"><a href="#节点亲和性" class="header-anchor">#</a> 节点亲和性</h4> <p>节点亲和性概念上类似于 <code>nodeSelector</code>， 它可以根据节点上的标签来约束 Pod 可以调度到哪些节点上。</p> <p>节点亲和性有两种：</p> <ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code>： 调度器只有在规则被满足的时候才能执行调度。此功能类似于 <code>nodeSelector</code>， 但其语法表达能力更强。</li> <li><code>preferredDuringSchedulingIgnoredDuringExecution</code>： 调度器会尝试寻找满足对应规则的节点。如果找不到匹配的节点，调度器仍然会调度该 Pod。</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/os
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> linux
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>key
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> another<span class="token punctuation">-</span>node<span class="token punctuation">-</span>label<span class="token punctuation">-</span>value
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/pause<span class="token punctuation">:</span><span class="token number">2.0</span>
</code></pre></div><p>在上面的配置中：</p> <ul><li>节点必须包含键名为 <code>kubernetes.io/os</code> 的标签，并且其取值为 <code>linux</code></li> <li>节点 <strong>最好</strong> 具有键名为 <code>another-node-label-key</code> 且取值为 <code>another-node-label-value</code> 的标签</li></ul> <p>可以使用 <code>operator</code> 字段来为 Kubernetes 设置在解释规则时要使用的逻辑操作符。 可以使用 <code>In</code>、<code>NotIn</code>、<code>Exists</code>、<code>DoesNotExist</code>、<code>Gt</code> 和 <code>Lt</code> 之一作为操作符。</p> <p><strong><code>NotIn</code> 和 <code>DoesNotExist</code> 可用来实现节点反亲和性行为</strong></p> <ul><li><p><font color="red">如果同时指定了 <code>nodeSelector</code> 和 <code>nodeAffinity</code>，<strong>两者</strong> 必须都要满足， 才能将 Pod 调度到候选节点上。</font></p></li> <li><p><font color="red">如果指定了多个与 <code>nodeAffinity</code> 类型关联的 <code>nodeSelectorTerms</code>， 只要其中一个 <code>nodeSelectorTerms</code> 满足的话，Pod 就可以被调度到节点上。</font></p></li> <li><p><font color="red">如果指定了多个与同一 <code>nodeSelectorTerms</code> 关联的 <code>matchExpressions</code>， 则只有当所有 <code>matchExpressions</code> 都满足时 Pod 才可以被调度到节点上。</font></p></li></ul> <h4 id="节点亲和性权重"><a href="#节点亲和性权重" class="header-anchor">#</a> 节点亲和性权重</h4> <blockquote><p>可以为 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 亲和性类型的每个实例设置 <code>weight</code> 字段，其取值范围是 1 到 100。 当调度器找到能够满足 Pod 的其他调度请求的节点时，调度器会遍历节点满足的所有的偏好性规则， 并将对应表达式的 <code>weight</code> 值加和。最终的加和值会添加到该节点的其他优先级函数的评分之上。 在调度器为 Pod 作出调度决定时，总分最高的节点的优先级也最高。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>affinity<span class="token punctuation">-</span>anti<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/os
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> linux
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> label<span class="token punctuation">-</span><span class="token number">1</span>
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> key<span class="token punctuation">-</span><span class="token number">1</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> label<span class="token punctuation">-</span><span class="token number">2</span>
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> key<span class="token punctuation">-</span><span class="token number">2</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/pause<span class="token punctuation">:</span><span class="token number">2.0</span>
</code></pre></div><p>如果存在两个候选节点，都满足 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 规则， 其中一个节点具有标签 <code>label-1:key-1</code>，另一个节点具有标签 <code>label-2:key-2</code>， 调度器会考察各个节点的 <code>weight</code> 取值，并将该权重值添加到节点的其他得分值之上。</p> <hr> <h3 id="nodename"><a href="#nodename" class="header-anchor">#</a> nodename</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span><span class="token number">01</span>
</code></pre></div><p>上面的 Pod 只能运行在节点 <code>kube-01</code> 之上。</p> <hr> <h2 id="污点和容忍度"><a href="#污点和容忍度" class="header-anchor">#</a> 污点和容忍度</h2> <blockquote><p><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity" target="_blank" rel="noopener noreferrer"><em>节点亲和性</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener noreferrer">Pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的一种属性，它使 Pod 被吸引到一类特定的<a href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/" target="_blank" rel="noopener noreferrer">节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> （这可能出于一种偏好，也可能是硬性要求）。 <em>污点</em>（Taint）则相反——它使节点能够排斥一类特定的 Pod。</p> <p>容忍度（Toleration）是应用于 Pod 上的，允许（但并不要求）Pod 调度到带有与之匹配的污点的节点上。</p> <p>污点和容忍度（Toleration）相互配合，可以用来避免 Pod 被分配到不合适的节点上。 每个节点上都可以应用一个或多个污点，这表示对于那些不能容忍这些污点的 Pod，是不会被该节点接受的。</p></blockquote> <p>使用</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl taint nodes node1 <span class="token assign-left variable">key1</span><span class="token operator">=</span>value1:NoSchedule
</code></pre></div><p>给节点添加一个污点</p> <p>给pod设置容忍度</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;key1&quot;</span>
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">&quot;Equal&quot;</span>
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;value1&quot;</span>
  <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">&quot;NoSchedule&quot;</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;key1&quot;</span>
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">&quot;Exists&quot;</span>
  <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">&quot;NoSchedule&quot;</span>
</code></pre></div><p>这两个容忍度都与上面的污点相匹配，pod拥有任意一个既能够被分配给node1</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;example-key&quot;</span>
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">&quot;Exists&quot;</span>
    <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">&quot;NoSchedule&quot;</span>

</code></pre></div><p><code>operator</code> 的默认值是 <code>Equal</code></p> <p>一个容忍度和一个污点相“匹配”是指它们有一样的键名和效果，并且：</p> <ul><li><code>operator</code> 是 <code>Exists</code> （此时容忍度不能指定 <code>value</code>）</li> <li><code>operator</code> 是 <code>Equal</code> ，它们的 <code>value</code> 应该相等</li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/notes/pages/ec9bd7/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">资源编排</div></a> <a href="/notes/pages/892142/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">controller</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/notes/pages/ec9bd7/" class="prev">资源编排</a></span> <span class="next"><a href="/notes/pages/892142/">controller</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/notes/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/notes/pages/892142/"><div>
            controller
            <!----></div></a> <span class="date">04-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/notes/pages/48d106/"><div>
            Service
            <!----></div></a> <span class="date">04-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/notes/pages/5ac46f/"><div>
            Jobs&amp;CronJob
            <!----></div></a> <span class="date">04-25</span></dt></dl> <dl><dd></dd> <dt><a href="/notes/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/notes/assets/js/app.6825a617.js" defer></script><script src="/notes/assets/js/2.e46b09ff.js" defer></script><script src="/notes/assets/js/47.75443c1b.js" defer></script>
  </body>
</html>
